<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>AmpliPi Updater</title>

    <link rel="shortcut icon" href="static/imgs/amplipi-small-logo.png">

    <!-- Font Awesome CSS -->
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css'
      onerror="this.onerror=null;this.href='static/css/libs/font-awesome/5.15.1/all.min.css';">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Bootstrap core CSS -->
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css'
      onerror="this.onerror=null;this.href='static/css/libs/twitter-bootstrap/4.5.0/bootstrap.min.css';">

    <!-- Custom styles -->
    <link href="static/css/jquery.dm-uploader.min.css" rel="stylesheet">
    <link href="static/css/styles.css" rel="stylesheet">
  </head>

  <body>

    <main role="main" class="container">
      <p class="">
        <a id="back-to-app" class="btn btn-primary btn-sm text-center" role="button" href="/#/settings" onclick="javascript:event.target.port=80"><i class="fa fa-arrow-left"></i> Back to App</a>
      </p>
      <h1><span class="text-white">Ampli</span><span class="text-danger">Pi</span></h1>
      <p class="lead mb-4">
        Update & configure your AmpliPi device
      </p>
      <div class="card">
        <!-- Navigation Tabs -->
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="latest-update-tab" data-toggle="tab" href="#latest-update" role="tab" aria-controls="latest-update" aria-selected="true">Latest Release</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="older-update-tab" data-toggle="tab" href="#older-update" role="tab" aria-controls="older-update" aria-selected="false">Older Releases</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="manual-update-tab" data-toggle="tab" href="#manual-update" role="tab" aria-controls="manual-update" aria-selected="false">Custom Update</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="admin-settings-tab" data-toggle="tab" href="#admin-settings" role="tab" aria-controls="admin-settings" aria-selected="false">Admin Settings</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="support-tunnel-tab" data-toggle="tab" href="#support-tunnel" role="tab" aria-controls="support-tunnel" aria-selected="false">Support Tunnel</a>
            </li>
          </ul>
        </div>
        <div class="card-body text-center">
          <div class="tab-content" id="myTabContent">

            <!-- Latest Update -->
            <div class="tab-pane fade show active" id="latest-update" role="tabpanel" aria-labelledby="latest-update-tab">
              <div id='latest-update-name'>...</div>
              <div id='latest-update-desc' class="text-left"></div>
              <a id="submit-latest-update" role="button" class="btn btn-lg btn-primary text-center mt-3 d-none"
                onclick="ui_start_software_update($('#latest-update').attr('data-url'), $('#latest-update').attr('data-version'));">
                Start Update</a>
            </div>

            <!-- Previous Updates -->
            <div class="tab-pane fade" id="older-update" role="tabpanel" aria-labelledby="older-update-tab">
              <select class="custom-select" id="older-update-sel" onchange="ui_select_release(this);">
                <!-- Releases populated from GH -->
                <option selected="">Choose...</option>
              </select>
              <div id='older-update-desc' class="text-left mt-2"></div>
              <a id="submit-older-update" role="button" class="btn btn-lg btn-primary text-center mt-3 disabled"
                 onclick="ui_start_software_update($('#older-update-sel').val(), $('#older-update-sel').find(':selected').data('version'));">
                Start Update</a>
            </div>

            <!-- Manual Update -->
            <div class="tab-pane fade" id="manual-update" role="tabpanel" aria-labelledby="manual-update-tab">
              <div class="custom-file">
                <input id="update-file-selector" type="file" accept=".gz" onchange="$('#submit-custom-update').removeClass('disabled');">
              </div>
              <a id="submit-custom-update" role="button" class="btn btn-lg btn-primary text-center mt-3 disabled" onclick="ui_upload_software_update();">Start Update</a>
            </div>

            <!-- Set Password -->
            <div class="tab-pane fade text-left" id="set-password" role="tabpanel" aria-labelledby="set-password-tab">
              <div class="set-password-dialog">
                This form allows you to set a password for the web interface. If the password fields are empty, it will unset the password protection. This will only set a password for the web interface, not the system password. This action will also log out any existing sessions.
              </div>
              <div class="set-password form-group">
                <label for="password" class="form-label">Password:</label>
                <input id="password" class="form-control" type="password">
                <label for="confirm-password" class="form-label">Confirm Password:</label>
                <input id="confirm-password" class="form-control" type="password">
              </div>
              <a id="password" role="button" class="btn btn-lg btn-primary text-center mt-3" onClick="set_password();">Update Password</a>
            </div>

            <!-- Support Tunnel -->
            <div class="tab-pane fade text-left" id="support-tunnel" role="tabpanel" aria-labelledby="support-tunnel-tab">
              <div id="support-tunnel-dialog">
                This dialog allows you to request a support tunnel. Once requested, you must give the tunnel ID and preshared key to support, who can be reached via <a href="mailto:support@micro-nova.com">support@micro-nova.com</a>.
              </div>
              <div id="support-tunnel-button">
                <a id="request-support-tunnel" role="button" class="btn btn-lg btn-primary text-center mt-3" onClick="requestSupportTunnel();">Request support tunnel
                  <div id="support-tunnel-spinner" class="spinner-border spinner-border-sm m-1 d-none" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                </a>
              </div>
              <div id="support-tunnel-detail-container" class="d-none">
                <pre id="support-tunnel-detail" class="alert alert-dark mt-3"></pre>
                <div id="support-tunnel-detail-caption" class="d-none">
                    Copy & paste the above lines in a support request, or <a id="support-tunnel-email"  target="_blank">email us.</a>
                </div>
              </div>
            </div>

            <!-- Admin Settings -->
            <div class="tab-pane fade text-left" id="admin-settings" role="tabpanel" aria-labelledby="admin-settings-tab">
              <script>
                function setVisibility(visible, ...others){
                  // Sets visibility of the first element to inline, the rest to none
                  visible.style.display = 'inline';
                  for(i=0; i < others.length; i++){
                    others[i].style.display = 'none';
                  }
                }

                async function getPersist() {
                  const response = await fetch("/settings/persist_logs", { method: "GET" });
                  const data = await response.json();
                  const checkbox = document.getElementById("persist-checkbox");
                  const textbox = document.getElementById("persist-input");
                  checkbox.checked = data.persist_logs;
                  textbox.value = data.auto_off_delay;
                }

                async function setPersist() {
                  const checkbox = document.getElementById("persist-checkbox");
                  const textbox = document.getElementById("persist-input");

                  const button = document.getElementById('persist-submit');
                  const spinner = document.getElementById('persist-spinner');
                  const success = document.getElementById('persist-success');
                  const fail = document.getElementById('persist-fail');

                  try {
                    setVisibility(spinner, button, success, fail);
                    const response = await fetch("/settings/persist_logs", {
                      method: "POST",
                      headers: {
                          "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                          persist_logs: checkbox.checked,
                          auto_off_delay: parseInt(textbox.value),
                      }),
                    });
                  if(response.ok){
                    setVisibility(success, spinner, button, fail);
                  } else {
                    setVisibility(fail, success, spinner, button);
                  }
                  } catch { // The same as response.ok == false
                    setVisibility(fail, success, spinner, button);
                  }

                  setTimeout(() => { // Reset to default after delay at the end
                    setVisibility(button, spinner, success, fail);
                  }, 1500);
                }

                async function getTimezones() {
                  const response1 = await fetch("/settings/timezones", {method: "GET"});
                  const timezones = await response1.json(); // All zones

                  const response2 = await fetch("/settings/timezone", {method: "GET"});
                  const timezone = await response2.json(); // Currently selected zone

                  const dropdown = document.getElementById("timezone-dropdown");

                  timezones.forEach(zone => {
                    const option = document.createElement("option");
                    console.log(`zone: ${zone}`)
                    option.value = zone;
                    option.textContent = zone;
                    if(zone == timezone){
                      option.selected = true;
                    }
                    dropdown.appendChild(option);
                  });
                }

                async function setTimezone() {
                  const timezone = document.getElementById("timezone-dropdown");
                  const response = await fetch("/settings/timezone", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "timezone": timezone.value })
                  });
                }

                async function getLogLevel() {
                  const response1 = await fetch("/settings/log_level", {method: "GET"});
                  const log_level = await response1.json(); // Get current log_level setting

                  const response2 = await fetch("/settings/log_levels", {method: "GET"});
                  const log_levels = await response2.json(); // Get all log_level options

                  const dropdown = document.getElementById("log-level-dropdown");

                  log_levels.forEach(level => {
                    const option = document.createElement("option");
                    console.log(`level: ${level}`)
                    option.value = level;
                    option.textContent = level;
                    if(level == log_level){
                      option.selected = true;
                    }
                    dropdown.appendChild(option);
                  });
                }

                async function setLogLevel() {
                  const log_level = document.getElementById("log-level-dropdown");
                  const response = await fetch("/settings/log_level", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "log_level": log_level.value })
                  });
                  const resp = await response.json()
                  console.log(`Log level attempted to set to: ${log_level.value}`);
                  console.log(`Log level actually set to: ${resp}`);
                }

                function initSettings(){
                  // Initialize all settings things here
                  getPersist();
                  getTimezones();
                  getLogLevel();
                }

                window.onload = initSettings;
              </script>

              <div id="admin-settings-dialog">
                This tab allows you to change settings relating to the core of AmpliPi
              </div>

              <!-- Password -->
              <div>
                <p class="">
                  <a class="btn btn-primary btn-sm text-center" id="set-password-button" data-toggle="tab" href="#set-password" role="tab" aria-controls="set-password" aria-selected="false">Set Password</a>
                </p>
              </div>

              <!-- Password -->
              <div id="set-password" style="display: flex; flex-direction: column; gap: 10px;">
                <div class="set-password form-group">
                  <h6>
                    Set Password
                  </h6>
                  <div class="set-password-dialog">
                    This form lets you set a web interface password. Leaving the fields empty will remove password protection. Note that this only affects the web interface, not the system password, and will log out any active sessions.
                  </div>
                  <div style="float: left">
                    <label for="password">Password:</label>
                    <input id="password" type="password">
                  </div>
                  <div style="float: left; margin-left: 10px;">
                    <label for="confirm-password" >Confirm Password:</label>
                    <input id="confirm-password" type="password">
                  </div>
                  <div style="float: left">
                    <a id="password" role="button" class="btn btn-primary btn-sm text-center" onClick="set_password();">Update Password</a>
                  </div>
                </div>
              </div>

              <!-- Log Persistence -->
              <div id="log-persistence" style="display: flex; flex-direction: column; gap: 10px;">
                <div class="log-persistence form-group">
                  <h6>
                    Log Persistence
                  </h6>
                  <div style="float: left;">
                    <input id="persist-checkbox" type="checkbox" onclick="setPersist()" />
                    <label for="persist-checkbox">Enable</label>
                  </div>
                  <div style="float: left; margin-left: 10px;">
                    <label for="persist-input" class="auto-off-label">
                      Auto Off Delay:
                      <span class="auto-off-tooltip">
                        the Auto Off function will deactivate persistant logs after the specified number of days.
                        <br/>
                        Input 0 to not automatically deactivate persistent logs, input 1 to deactivate it tonight at midnight.
                      </span>
                    </label>
                    <input id="persist-input" />
                  </div>
                  <div style="float: left; margin-left: 10px;">
                    <a id="persist-submit" role="button" class="btn btn-primary btn-sm text-center" onClick="setPersist()">Save Persistence & Delay</a>
                    <a id="persist-success" role="button" class="btn btn-primary btn-sm text-center" style="display: none; background-color: #00AA00;">Success!</a>
                    <a id="persist-fail" role="button" class="btn btn-primary btn-sm text-center" style="display: none; background-color: #DD0000;">Failure...</a>
                    <div id="persist-spinner" style="display: none;">
                      <i class="fa fa-circle-o-notch fa-spin" style="font-size:24px"></i>
                    </div>
                  </div>
                </div>
                <div class="set-password-dialog">
                  WARNING: Leaving log persistence on for extended periods can damage your system.
                </div>
              </div>

              <!-- Timezone -->
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <h6>
                  NOTE: Clicking "Set Timezone" button will push the change to the system, but will need a system reboot to apply
                  <br/>
                  Go to the config page in the standard config settings page to do a system reboot
                </h6>
                <div>
                  <div style="float: left">
                    <label for="timezone-dropdown">Timezone:</label>
                    <select name="timezone-dropdown" id="timezone-dropdown" style="width: fit-content">
                      <!-- Empty until populated by getTimezones function -->
                    </select>
                  </div>
                  <div style="float: left">
                    <button id="post-timezone-button" type="button" class="btn btn-primary btn-sm text-center" onclick={setTimezone()}>Set Timezone</button>
                  </div>
                </div>
              </div>

              <!-- Log Level -->
              <div style="margin-top: 20px;">
                  <label for="log-level-dropdown">Log Level:</label>
                  <select name="log-level-dropdown" id="log-level-dropdown" style="width: fit-content" onchange={setLogLevel()}>
                    <!-- Empty until populated by getLogLevels function -->
                  </select>
              </div>

            </div>

          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
           <div id="update-log" class="card">
            <div class="card-header">
              Update Log
            </div>

            <ul class="list-group list-group-flush" id="debug">
              <li class="list-group-item text-muted empty"></li>
            </ul>
          </div>
        </div>
      </div> <!-- /debug -->

    </main> <!-- /container -->

    <!-- jQuery JS CDN -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
    <!-- jQuery JS local fallback -->
    <script>window.jQuery || document.write('<script src="static/js/libs/jquery/3.5.1/jquery.min.js"><\/script>')</script>
    <!-- jQuery UI JS CDN -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js'></script>
    <!-- jQuery JS local fallback -->
    <script>(window.jQuery.ui === undefined) && document.write('<script src="static/js/libs/jqueryui/1.12.1/jquery-ui.min.js"><\/script>')</script>
    <!-- Bootstrap JS CDN -->
    <script src='https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js'></script>
    <!-- Bootstrap JS local fallback -->
    <script>(typeof($.fn.modal) === 'undefined') && document.write('<script src="static/js/libs/bootstrap/4.5.2/bootstrap.bundle.min.js"><\/script>')</script>
    <!-- Remarkable JS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/remarkable/2.0.1/remarkable.min.js"></script>
    <!-- Remarkable JS CDN local fallback -->
    <script>window.remarkable || document.write('<script src="static/js/libs/remarkable/2.0.1/remarkable.min.js"><\/script>')</script>

    <script src="static/js/update-ui.js"></script>

    <!-- File item template -->
    <script type="text/html" id="files-template">
      <li class="media">
        <div class="media-body mb-1">
          <p class="mb-2">
            <strong>%%filename%%</strong> - Status: <span class="text-muted">Waiting</span>
          </p>
          <div class="progress mb-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            </div>
          </div>
          <hr class="mt-1 mb-1" />
        </div>
      </li>
    </script>

    <!-- Debug item template -->
    <script type="text/html" id="debug-template">
      <li class="list-group-item text-%%color%%"><strong>%%date%%</strong>: %%message%%</li>
    </script>
  </body>
</html>
